name: Release Plugin

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Build plugin
        run: dotnet publish Jellyfin.Plugin.DoesTheDogDie/Jellyfin.Plugin.DoesTheDogDie.csproj -c Release -o output

      - name: Create ZIP package
        run: |
          cd output
          zip -j ../doesthedogdie-${{ github.event.release.tag_name }}.zip Jellyfin.Plugin.DoesTheDogDie.dll

      - name: Calculate checksum
        id: checksum
        run: echo "md5=$(md5sum doesthedogdie-${{ github.event.release.tag_name }}.zip | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: doesthedogdie-${{ github.event.release.tag_name }}.zip

      - name: Update manifest on gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages

          # Update manifest.json with new version
          jq --arg version "${{ github.event.release.tag_name }}" \
             --arg checksum "${{ steps.checksum.outputs.md5 }}" \
             --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             --arg changelog "${{ github.event.release.body }}" \
             '.[0].versions = [{
               "version": $version,
               "changelog": $changelog,
               "targetAbi": "10.11.0.0",
               "sourceUrl": "https://github.com/theflanman/dtdd-jellyfin-plugin/releases/download/\($version)/doesthedogdie-\($version).zip",
               "checksum": $checksum,
               "timestamp": $timestamp
             }] + .[0].versions' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git commit -m "Update manifest for ${{ github.event.release.tag_name }}"
          git push origin gh-pages
